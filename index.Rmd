---
title: "COVID-19"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

Analysis of the COVID-19 pandemic in the United States using data from the [COVID Tracking Project](https://covidtracking.com/)

Code is written in R Markdown and is available at https://github.com/gitmezzy/covid-19

```{r include=FALSE}
library(data.table)
library(dtplyr)
library(tidyr)
library(dplyr, warn.conflicts = FALSE)
library(readr)
library(lubridate)
library(zoo)
library(plotly)

df <- read_csv("https://covidtracking.com/api/v1/states/daily.csv")

df <-
  df %>%
  bind_rows(
    df %>%
      group_by(date) %>%
      summarise_if(is.numeric, sum, na.rm = TRUE) %>%
      mutate(state = "US")
  )

df %<>%
  lazy_dt() %>%
  mutate(date = ymd(date)) %>%
  arrange(state, date) %>%
  group_by(state) %>%
  mutate(
    dailyDeaths = death - lag(death),
    dailyDeathsRollMean = rollmean(dailyDeaths, 7, fill = NA),
    dailyTests = (positive + negative) - lag(positive + negative),
    dailyTestsRollMean = rollmean(dailyTests, 7, fill = NA),
    dailyPositiveTests = positive - lag(positive),
    dailyPositiveTestsRollMean = rollmean(dailyPositiveTests, 7, fill = NA),
    dailyNegativeTests = negative - lag(negative),
    dailyNegativeTestsRollMean = rollmean(dailyNegativeTests, 7, fill = NA),
    dailyPositiveRate = 100*dailyPositiveTests/(dailyPositiveTests+dailyNegativeTests),
    dailyPositiveRateRollMean = 100*dailyPositiveTestsRollMean/(dailyPositiveTestsRollMean+dailyNegativeTestsRollMean),
    dailyActualCases = 100*dailyPositiveTests^2/dailyTests,
    dailyActualCasesRollMean = rollmean(dailyActualCases, 7, fill = NA)) %>%
  as_tibble()

df <- df %>% replace_na(list(dailyActualCases = 0, dailyPositiveTests = 0, dailyDeaths = 0))

df %<>%
  lazy_dt() %>%
  arrange(state, date) %>%
  group_by(state) %>%
  mutate(
    totalActualCases = cumsum(dailyActualCases),
    totalActualCasesRollMean = rollmean(totalActualCases, 7, fill = NA),
    totalPositiveTests = cumsum(dailyPositiveTests),
    totalPositiveTestsRollMean = rollmean(totalPositiveTests, 7, fill = NA),
    totalDeaths = cumsum(dailyDeaths),
    totalDeathsRollMean = rollmean(totalDeaths, 7, fill = NA)) %>%
  as_tibble()

df_US <-
  df %>%
  filter(state == "US", .preserve = TRUE)
```

## Estimated Actual Cases
One way to estimate the actual number of cases is to normalize the confirmed positive tests by the test positive rate and multiply by a constant.

$\large estimated\hspace{1mm}actual\hspace{1mm}cases\hspace{1mm} = 100*test\hspace{1mm}positive\hspace{1mm}rate*positive\hspace{1mm}tests$

```{r dailyActualCases, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~dailyActualCases, type = 'scatter', mode = 'lines', color = I('gray'), name = 'Daily', width=1000)
fig <- fig %>% add_trace(y = ~dailyActualCasesRollMean, color = I('red'), name = '7 day rolling average')
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Estimated Actual Daily Cases [thousands]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```

```{r totalActualCases, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~totalActualCases, type = 'scatter', mode = 'lines', color = I('black'), name = 'Daily', width=800)
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Estimated Actual Total Cases [millions]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```

## Percent of U.S. Population Infected
```{r percentPopulationInfected, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~100*totalActualCases/328239523, type = 'scatter', mode = 'lines', color = I('black'), name = 'Based on Estimated Actual Cases', width=800)
fig <- fig %>% add_trace(y = ~100*positiveTestsAntibody/(positiveTestsAntibody+negativeTestsAntibody), color = I('blue'), name = 'Based on Antibody Tests')
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Percent of U.S. Population Infected [%]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig <- fig %>% layout(legend = list(x = 0.6, y = 0.9))
fig
```

## Hospitalized Currently
```{r hospitalized, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~hospitalizedCurrently, type = 'scatter', mode = 'lines', color = I('black'), name = 'Daily', width=800)
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Hospitalized Currently [thousands]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```

## Deaths
```{r dailyDeaths, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~dailyDeaths, type = 'scatter', mode = 'lines', color = I('gray'), name = 'Daily', width=1000)
fig <- fig %>% add_trace(y = ~dailyDeathsRollMean, color = I('red'), name = '7 day rolling average')
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Daily Deaths"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```

```{r totalDeaths, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~totalDeaths, type = 'scatter', mode = 'lines', color = I('black'), name = 'Daily', width=800)
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Total Deaths [thousands]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```

## Test Positive Rate
The test positive rate is the percent of all COVID-19 tests that are positive.

$\large test\hspace{1mm}positive\hspace{1mm}rate\hspace{1mm} [\%] = 100*(\frac{positive\hspace{1mm}tests}{positive\hspace{1mm}tests + negative\hspace{1mm}tests})$

According to [Johns Hopkins](https://www.jhsph.edu/covid-19/articles/covid-19-testing-understanding-the-percent-positive.html):

>
The percent positive will be high if the number of positive tests is too high, or if the number of total tests is too low. A higher percent positive suggests higher transmission and that there are likely more people with coronavirus in the community who haven’t been tested yet.

>
The percent positive is a critical measure because it gives us an indication how widespread infection is in the area where the testing is occurring—and whether levels of testing are keeping up with levels of disease transmission.

>
A high percent positive means that more testing should probably be done—and it suggests that it is not a good time to relax restrictions aimed at reducing coronavirus transmission. Because a high percentage of positive tests suggests high coronavirus infection rates (due to high transmission in the community), a high percent positive can indicate it may be a good time to add restrictions to slow the spread of disease.

```{r testPositiveRate, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~dailyPositiveRate, type = 'scatter', mode = 'lines', color = I('gray'), name = 'Daily', width=1000)
fig <- fig %>% add_trace(y = ~dailyPositiveRateRollMean, color = I('red'), name = '7 day rolling average')
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Test Positive Rate [%]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig

```

## Confirmed Cases
```{r confirmedCases, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~dailyPositiveTests, type = 'scatter', mode = 'lines', color = I('gray'), name = 'Daily', width=1000)
fig <- fig %>% add_trace(y = ~dailyPositiveTestsRollMean, color = I('red'), name = '7 day rolling average')
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Confirmed Daily Cases [thousands]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```

```{r totalConfirmedCases, echo=FALSE}
fig <- plot_ly(df_US, x = ~date, y = ~totalPositiveTests, type = 'scatter', mode = 'lines', color = I('black'), name = 'Daily', width=800)
fig <- fig %>% layout(legend = list(orientation = 'v'))
fig <- fig %>% layout(yaxis = list(title = "Total Confirmed Cases [millions]"))
fig <- fig %>% layout(xaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      yaxis = list(titlefont = list(size = 22), tickfont = list(size = 16)),
                      legend = list(font = list(size = 16)))
fig
```
