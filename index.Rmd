---
title: "COVID-19"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Analysis of the COVID-19 pandemic in the United States using data from the [COVID Tracking Project](https://covidtracking.com/)

Code is written in R Markdown and is available at https://github.com/gitmezzy/covid-19

```{r include=FALSE}
library(data.table)
library(dtplyr)
library(dplyr, warn.conflicts = FALSE)
library(readr)
library(lubridate)
library(zoo)
library(ggplot2)
library(plotly)

df <- read_csv("https://covidtracking.com/api/v1/states/daily.csv")

df <-
  df %>%
  bind_rows(
    df %>%
      group_by(date) %>%
      summarise_if(is.numeric, sum, na.rm = TRUE) %>%
      mutate(state = "US")
  )

df %<>%
  lazy_dt() %>%
  mutate(date = ymd(date)) %>%
  arrange(state, date) %>%
  group_by(state) %>%
  mutate(
    dailyDeaths = death - lag(death),
    dailyDeathsRollMean = rollmean(dailyDeaths,7, na.pad=TRUE, align="right"),
    dailyTests = (positive + negative) - lag(positive + negative),
    dailyTestsRollMean = rollmean(dailyTests,7, na.pad=TRUE, align="right"),
    dailyPositiveTests = positive - lag(positive),
    dailyPositiveTestsRollMean = rollmean(dailyPositiveTests,7, na.pad=TRUE, align="right"),
    dailyNegativeTests = negative - lag(negative),
    dailyNegativeTestsRollMean = rollmean(dailyNegativeTests,7, na.pad=TRUE, align="right"),
    dailyPositiveRate = 100*dailyPositiveTests/(dailyPositiveTests+dailyNegativeTests),
    dailyPositiveRateRollMean = 100*dailyPositiveTestsRollMean/(dailyPositiveTestsRollMean+dailyNegativeTestsRollMean)) %>%
  as_tibble()

df_US <-
  df %>%
  filter(state == "US", .preserve = TRUE)
```

## United States
This section focuses on the United States as a whole. Analysis for individual states is in the next section.

### Test Positive Rate
The test positive rate is the percent of all COVID-19 tests that are positive.

$\large test\hspace{1mm}positive\hspace{1mm}rate\hspace{1mm} [\%] = 100(\frac{positive\hspace{1mm}tests}{positive\hspace{1mm}tests + negative\hspace{1mm}tests})$

According to [Johns Hopkins](https://www.jhsph.edu/covid-19/articles/covid-19-testing-understanding-the-percent-positive.html):

>
The percent positive will be high if the number of positive tests is too high, or if the number of total tests is too low. A higher percent positive suggests higher transmission and that there are likely more people with coronavirus in the community who haven’t been tested yet.

>
The percent positive is a critical measure because it gives us an indication how widespread infection is in the area where the testing is occurring—and whether levels of testing are keeping up with levels of disease transmission.

>
A high percent positive means that more testing should probably be done—and it suggests that it is not a good time to relax restrictions aimed at reducing coronavirus transmission. Because a high percentage of positive tests suggests high coronavirus infection rates (due to high transmission in the community), a high percent positive can indicate it may be a good time to add restrictions to slow the spread of disease.

```{r pressure, echo=FALSE}
colors <- c("Daily" = "black", "7 day rolling average" = "red")

p <-
  df_US %>%
  ggplot(aes(date)) + 
  geom_line(aes(y = dailyPositiveRate, color = "Daily"), size = 0.25) + 
  geom_line(aes(y = dailyPositiveRateRollMean, color = "7 day rolling average"), size = 1) +
  ylab("Test Positive Rate [%]") +
  theme(axis.text.x = element_text(size = rel(1.5))) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.y = element_text(size = rel(1.5))) +
  theme(axis.title.y = element_text(size = rel(1.5))) +
  ggtitle('United States Test Positive Rate') +
  scale_color_manual(values = colors) +
  theme(legend.text = element_text(size = 14))

ggplotly(p) %>%
  layout(legend = list(orientation = "v", x = 0.6))
```

## Individual States